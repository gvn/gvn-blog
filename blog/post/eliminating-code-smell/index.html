<html><head><title>Gavin Lazar Suntop</title><meta name="description" content="More Posts About Food and Revolutionary Art"/><meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0"/><meta property="og:site_name" content="Gavin Lazar Suntop"/><meta property="og:title" content="Eliminating Code Smell With Grunt"/><meta property="og:description" content="Gavin Lazar Suntop â€“ &quot;More Posts About Food and Revolutionary Art&quot;"/><meta property="og:type" content="website"/><meta property="og:image" content="http://gsuntop.com/blog/img/eliminating-code-smell/og-thumb.jpg"/><link href="/blog/css/main.css" media="all" rel="stylesheet" type="text/css"/><link href="/blog/css/glyphs.css" media="all" rel="stylesheet" type="text/css"/></head><body><h2 class="logo"><span class="sr-only">Gavin Lazar Suntop</span><a href="/"><img src="/blog/img/wordmark.png"/></a></h2><header><h1>Eliminating Code Smell With Grunt</h1><p class="subheader"><time><em>December 12th, 2013</em></time></p></header><main class="markdown"><h2 id="intro">Intro</h2>
<p>I <em>love</em> clean code. There, I said it. I pride myself on passing strict linting standards and keeping my code easy to read. It&#39;s not just a personal proclivity, but a choice I hope benefits other developers.</p>
<p>My general experience with teams has been that code style is something people care about and have strong personal preferences. Typically, at some point people get tired of dealing with inconsistency and a standardization meeting is called. This is, of course, an important discussion to have. The problem that tends to occur is either lack of documentation or lack of enforcement of the agreed upon style. Additionally, new team members or contributors may not have access to a clear set of rules.</p>
<p>Beyond the challenge of defining rules lies the supreme annoyance of enforcing them. Code reviews become cluttered with nits to be picked. Time is wasted. The solution I settled on was simply automating the conformance process.</p>
<p>I set forth to solve this problem:</p>
<p><strong>Establish coding standards that are clearly defined and automatically verifiable.</strong></p>
<h2 id="defining-the-rules">Defining the Rules</h2>
<p>Probably the most difficult part of crafting a style guide is agreeing on what standards to use. In all likelihood there will be some standards in place already. It&#39;s likely (at least I hope) that your team at least has an indentation standard. This is a holy war for some, but hopefully you&#39;ve already reached a consensus.</p>
<p>Coding standards are like pizza toppings; it&#39;s difficult for people to agree on them. However, most can agree that no matter what, consistency is a desirable goal.</p>
<p>In order to automate style, you need to pick tools to perform static analysis of your code. Since the bulk of our code in the <a href="http://webmaker.org">Webmaker</a> ecosystem is JavaScript I decided to use two tools: <a href="http://jshint.com/">JSHint</a> and <a href="https://github.com/einars/js-beautify">JSBeautify</a>. Both are configurable with JSON files that are easily added to a project&#39;s root directory: <code>.jshintrc</code> and <code>.jsbeautifyrc</code> respectively.</p>
<h3 id="fig-1-jshintrc-from-webmaker-org">Fig. 1 - .jshintrc from webmaker.org</h3>
<pre><code class="lang-json">{
  &quot;globals&quot;: {
    &quot;module&quot;: true,
    &quot;define&quot;: true,
    &quot;requirejs&quot;: true,
    &quot;require&quot;: true
  },
  &quot;browser&quot;: true,
  &quot;bitwise&quot;: true,
  &quot;curly&quot;: true,
  &quot;eqeqeq&quot;: true,
  &quot;freeze&quot;: true,
  &quot;immed&quot;: true,
  &quot;indent&quot;: 2,
  &quot;latedef&quot;: true,
  &quot;newcap&quot;: true,
  &quot;noempty&quot;: true,
  &quot;nonew&quot;: true,
  &quot;trailing&quot;: true,
  &quot;undef&quot;: true
}
</code></pre>
<h3 id="fig-2-jsbeautifyrc-from-webmaker-org">Fig. 2 - .jsbeautifyrc from webmaker.org</h3>
<pre><code class="lang-json">{
  &quot;indent_size&quot;: 2,
  &quot;indent_char&quot;: &quot; &quot;,
  &quot;indent_level&quot;: 0,
  &quot;indent_with_tabs&quot;: false,
  &quot;preserve_newlines&quot;: true,
  &quot;max_preserve_newlines&quot;: 2,
  &quot;jslint_happy&quot;: true,
  &quot;brace_style&quot;: &quot;collapse&quot;,
  &quot;keep_array_indentation&quot;: false,
  &quot;keep_function_indentation&quot;: false,
  &quot;space_before_conditional&quot;: true,
  &quot;break_chained_methods&quot;: false,
  &quot;eval_code&quot;: false,
  &quot;unescape_strings&quot;: false,
  &quot;wrap_line_length&quot;: 0
}
</code></pre>
<h2 id="automating-with-grunt">Automating with Grunt</h2>
<p>Once your choices have been established, you need to document them. Your project should have a <code>CONTRIBUTING.md</code> if you&#39;re using GitHub, which is a fine place to start. Of course, simply relying on documentation is prone to error and will inevitably result in nitpicky code reviews. To solve the automation component of my challenge, I decided to use the fantastic <a href="http://gruntjs.com/">Grunt</a> task runner.</p>
<p>(I will assume you have a working knowledge of Grunt, but if not, <a href="http://www.youtube.com/watch?v=q3Sqljpr-Vc">here&#39;s a good starting point</a>.)</p>
<p>Since Grunt&#39;s core function is automation it felt like a perfect choice. We had already been using it <a href="https://github.com/mozilla/webmaker-profile/blob/master/Gruntfile.js">for other purposes</a>, so I only needed to bring in a few plugins to work with the tools and config files already established. I chose to use <a href="https://github.com/gruntjs/grunt-contrib-jshint">grunt-contrib-jshint</a> and <a href="https://github.com/vkadam/grunt-jsbeautifier">grunt-jsbeautifier</a>.</p>
<p>After installing and loading the NPM tasks in our Gruntfile, I needed to define two configurations.</p>
<p>For <strong>JSHint</strong>, the configuration is very simple. Target files are defined and we pull in our previously defined rules from the <code>.jshintrc</code> file to set the linter&#39;s rules.</p>
<pre><code class="lang-js">jshint: {
  all: [&#39;Gruntfile.js&#39;, &#39;_fe/js/*.js&#39;],
  options: {
    jshintrc: &#39;.jshintrc&#39;
  }
}
</code></pre>
<p>For <strong>JSBeautifier</strong> the config is slightly more complex. Since this tool typically auto-formats our code I created an additional sub task for verification only. This allows us to test that code has been formatted without actually modifying it.</p>
<pre><code class="lang-js">jsbeautifier: {
  modify: {
    src: [&#39;Gruntfile.js&#39;, &#39;_fe/js/**/*.js&#39;],
    options: {
      config: &#39;.jsbeautifyrc&#39;
    }
  },
  verify: {
    src: [&#39;Gruntfile.js&#39;, &#39;_fe/js/**/*.js&#39;],
    options: {
      mode: &#39;VERIFY_ONLY&#39;,
      config: &#39;.jsbeautifyrc&#39;
    }
  }
}
</code></pre>
<p>My final step to configure Grunt was to add two tasks.</p>
<ol>
<li><p><code>grunt clean</code> to auto-format and ensure JSHint compliance:</p>
<pre><code class="lang-js">grunt.registerTask(&#39;clean&#39;, [
 &#39;jsbeautifier:modify&#39;,
 &#39;jshint&#39;
]);
</code></pre>
</li>
<li><p><code>grunt verify</code> to check that code is formatted and passes JSHint:</p>
<pre><code class="lang-js">grunt.registerTask(&#39;verify&#39;, [
 &#39;jsbeautifier:verify&#39;,
 &#39;jshint&#39;
]);
</code></pre>
</li>
</ol>
<h2 id="workflow">Workflow</h2>
<p>In the spirit of keeping things simple, a developer only has to run and pass <code>grunt clean</code> before pushing code. JSHint will alert the user to any violations, which must be cleaned up manually. JSBeautifier will just do its thing with no further typing required.</p>
<h2 id="enforcement">Enforcement</h2>
<p>To take things a little further, I decided to integrate our verification task with <a href="https://travis-ci.org/">Travis</a>. Since you&#39;ll already have a <code>package.json</code> from working with Grunt, you can just add a NPM test to your <code>scripts</code> property like so:</p>
<pre><code class="lang-js">&quot;scripts&quot;: {
  &quot;test&quot;: &quot;grunt verify --verbose&quot;
}
</code></pre>
<p>This will result in your build failing if <code>grunt verify</code> doesn&#39;t pass. As a bonus, you&#39;ll get this lovely banner on your validated pull requests:</p>
<p><img src="/blog/img/eliminating-code-smell/travis.png" alt="Light is green. Trap is clean."></p>
<p><em>&quot;Light is green. Trap is clean.&quot;</em></p>
<h2 id="conclusion">Conclusion</h2>
<p>Overall, I found that putting this solution in place has improved not only the readability and consistency of our code, but also reduced potential errors via static analysis with JSHint. On the projects that I&#39;ve integrated so far, I&#39;ve noticed that more focus is given to <em>what the code is actually doing</em> in reviews. Also, with open source projects it&#39;s a wonderful way to ensure contributors maintain consistency with their patches. There may be a gentle reminder to run <code>grunt clean</code> now and then, but extensive nit picking is no longer required from reviewers.</p>
<hr>
<h3 id="bonus-materials">Bonus Materials</h3>
<h4 id="sublime-text-packages">Sublime Text Packages</h4>
<p>These packages can read options directly from your local <code>.*rc</code> files</p>
<ul>
<li><a href="https://github.com/victorporof/Sublime-HTMLPrettify">HTML-CSS-JS Prettify</a></li>
<li><a href="https://github.com/SublimeLinter/SublimeLinter">SublimeLinter</a></li>
</ul>
<h4 id="further-reading">Further Reading</h4>
<ul>
<li><a href="http://www.altdevblogaday.com/2011/12/24/static-code-analysis/">Static Code Analysis</a> by John Carmack</li>
<li><a href="http://shop.oreilly.com/product/9780596802301.do">The Art of Readable Code</a> by Dustin Boswell, Trevor Foucher</li>
</ul>
<h4 id="additional-tools">Additional Tools</h4>
<ul>
<li><a href="https://github.com/mdevils/node-jscs">jscs</a></li>
</ul>
</main><div class="interpost-navigator"><div class="direction previous"></div><div class="direction next"><p>Next up</p><a href="/blog/post/npm-front-end">npm for Front-end Libraries</a></div></div><ul class="tags"><li><a href="/blog/tag/grunt">grunt</a></li><li><a href="/blog/tag/javascript">javascript</a></li><li><a href="/blog/tag/code">code</a></li></ul><hr/><footer><a href="http://twitter.com/gvn" target="_blank" class="square-link"><i class="icon-twtr"></i> twitter / gvn</a><br/><a href="http://github.com/gvn" target="_blank" class="square-link"><i class="icon-gh"></i> github / gvn</a><br/><br/><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US" target="_blank" class="square-link"><i class="icon-cc"></i> BY-NC-SA</a></footer></body></html>